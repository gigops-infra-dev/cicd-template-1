---
name: Merge
on:
  pull_request:
    branches:
      - main
      - staging
    types: [closed]

permissions: write-all
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  TERRAFORM_BASE_DIR: terraform

jobs:
  check-targets:
    runs-on: ubuntu-latest
    outputs:
      init_url: ${{ steps.check.outputs.init_url }}
      plan_url: ${{ steps.check.outputs.plan_url }}
      apply_url: ${{ steps.check.outputs.apply_url }}
      target_dir: ${{ steps.check.outputs.target_dir }}
    steps: 
      - uses: actions/checkout@v3
      - id: check
        uses: ./.github/actions/read-pull-requests

  apply:
    runs-on: ubuntu-latest
    needs: check-targets
    if: ${{ needs.check-targets.outputs.target_dir != '' }}
    steps:
      - name: Generate github token
        id: generate_token
        uses: tibdex/github-app-token@v1
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.PRIVATE_KEY }}

      - uses: actions/checkout@v3
        with:
          token: ${{ steps.generate_token.outputs.token }}
      - id: setup-envs
        uses: ./.github/actions/setup-envs
        with:
          base_ref: ${{ github.base_ref }}
          head_ref: ${{ github.head_ref }}
      - uses: ./.github/actions/setup-terraform
        with:
          working_directory: ./${{env.TERRAFORM_BASE_DIR}}/${{ steps.setup-envs.outputs.ghaction_target }}
      - uses: ./.github/actions/setup-aws-credentials
        with:
          aws_role_arn: ${{ steps.setup-envs.outputs.aws_role_arn }}
          aws_profile: ${{ steps.setup-envs.outputs.aws_profile }}
          aws_region: ap-northeast-1
          ssh_key: ${{ secrets.RSA }}

      - id: init
        uses: ./.github/actions/terragrunt-init
        with:
          aws_profile: ${{ steps.setup-envs.outputs.aws_profile }}
          working_directory: ./${{ env.TERRAFORM_BASE_DIR }}/${{ steps.setup-envs.outputs.ghaction_target }}
          target_dir: ${{ needs.check-targets.outputs.target_dir }}
          git_ssh_command: ssh -i /tmp/id_rsa -o UserKnownHostsFile=./known_hosts
          tf_workspace: ${{ steps.setup-envs.outputs.tf_workspace }}
          init_url: ${{ needs.check-targets.outputs.init_url }}
          plan_url: ${{ needs.check-targets.outputs.plan_url }}
          apply_url: ${{ needs.check-targets.outputs.apply_url }}
          is_write_pr: false

      - id: apply
        if: ${{ steps.init.outcome == 'success' }} 
        uses: ./.github/actions/terragrunt-apply
        with:
          aws_profile: ${{ steps.setup-envs.outputs.aws_profile }}
          target_dir: ${{ needs.check-targets.outputs.target_dir }}
          git_ssh_command: ssh -i /tmp/id_rsa -o UserKnownHostsFile=./known_hosts
          tf_workspace: ${{ steps.setup-envs.outputs.tf_workspace }}
          working_directory: ./${{ env.TERRAFORM_BASE_DIR }}/${{ steps.setup-envs.outputs.ghaction_target }}
          apply_url: ${{ needs.check-targets.outputs.apply_url }}
          github_action_token: ${{ steps.generate_token.outputs.token }}
        
  create-pr:
    runs-on: ubuntu-latest
    needs: check-targets
    env:
      BASE_REF: main
      HEAD_REF: staging
    if: ${{ needs.check-targets.outputs.target_dir == '' && github.base_ref  == 'staging' }}
    steps:
      - name: Generate github token
        id: generate_token
        uses: tibdex/github-app-token@v1
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.PRIVATE_KEY }}

      - uses: actions/checkout@v3      
        with:
          fetch-depth: 0
          token: ${{ steps.generate_token.outputs.token }}

      - uses: ./.github/actions/split-branch
        with:
          base_ref: ${{ env.BASE_REF }}
          head_ref: ${{ env.HEAD_REF }}
          github_action_token: ${{ steps.generate_token.outputs.token }}

  split-branch:
    runs-on: ubuntu-latest
    needs: [check-targets,apply]
    if: ${{ success() && github.base_ref  == 'staging' }}
    env:
      BASE_REF: main
      HEAD_REF: staging
    steps:
      - name: Generate github token
        id: generate_token
        uses: tibdex/github-app-token@v1
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.PRIVATE_KEY }}

      - run: |
          target=$(echo ${GITHUB_HEAD_REF} | awk -F "_" '{ print $NF }')
          echo "TARGET_DIR=$target" >> $GITHUB_ENV

      - uses: actions/checkout@v3
        with:
          token: ${{ steps.generate_token.outputs.token }}
          ref: ${{ env.HEAD_REF }}
          fetch-depth: 0

      - uses: ./.github/actions/split-branch
        continue-on-error: true
        with:
          base_ref: ${{ env.BASE_REF }}
          head_ref: ${{ env.HEAD_REF }}
          target_dir: ${{ env.TARGET_DIR }}
          github_action_token: ${{ steps.generate_token.outputs.token }}